<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>От классики к ML в прогнозировании спроса — интерактив</title>
<style>
  :root{
    --bg:#0b0f14; --panel:#121821; --muted:#1b2430; --text:#e6edf3; --sub:#9fb3c8;
    --accent:#5aa9ff; --accent2:#ffd166; --ok:#2ecc71; --warn:#ffb703; --bad:#ff6b6b;
    --grid:#223042; --line1:#5aa9ff; --line2:#ffd166; --band:#5aa9ff33; --bar:#8ecae6;
  }
  *{box-sizing:border-box}
  html,body{height:100%;}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}

  /* ====== Layout ====== */
  .wrap{display:grid;grid-template-columns:320px 1fr; gap:14px; padding:14px;}
  aside{background:var(--panel); border:1px solid #0e141b; border-radius:12px; padding:12px; max-height:calc(100vh - 28px); overflow:auto}
  main{display:flex; flex-direction:column; gap:10px}

  /* ====== Typography ====== */
  h1{font-size:18px; margin:0 0 6px 0}
  .section{border-top:1px solid #0f1620; padding-top:10px; margin-top:10px}
  label, .hint{color:var(--sub)}

  /* ====== Form rows ====== */
  .row{display:flex; align-items:center; justify-content:space-between; gap:8px; margin:6px 0}
  .row input[type="number"], .row input[type="text"]{width:70px; background:#0e141b; border:1px solid #1c2735; color:var(--text); border-radius:8px; padding:6px}
  .row input[type="range"]{width:100%}
  .chips{display:flex; flex-wrap:wrap; gap:6px}
  .chip{background:var(--muted); color:var(--sub); padding:6px 8px; border-radius:999px; font-size:12px}

  /* ====== Cards & grids ====== */
  .grid{background:var(--panel); border:1px solid #0e141b; border-radius:12px; padding:10px}
  .kpi{display:grid; grid-template-columns:repeat(6,1fr); gap:8px}
  .k{background:var(--panel); border:1px solid #0e141b; border-radius:10px; padding:10px}
  .k b{display:block; font-size:12px; color:var(--sub)}
  .k big{font-size:18px}
  .good{color:var(--ok)} .mid{color:var(--warn)} .bad{color:var(--bad)}
  .toolbar{display:flex; gap:8px; align-items:center; justify-content:flex-end}
  button{background:linear-gradient(180deg,#1a2230,#131b26); color:var(--text); border:1px solid #223042; padding:8px 10px; border-radius:10px; cursor:pointer}
  button:hover{filter:brightness(1.05)}
  .model-note{font-size:12px; color:var(--sub)}
  .two{display:grid; grid-template-columns: 2fr 1fr; gap:10px}

  /* ====== Tables ====== */
  table{width:100%; border-collapse:collapse}
  th,td{border-bottom:1px dashed #203042; padding:8px; text-align:right}
  th:first-child, td:first-child{text-align:left}
  .tag{font-size:11px; color:var(--sub)}
  .warnline{font-size:12px; color:var(--warn)}
  .foot{display:flex; gap:8px; align-items:center; justify-content:space-between}
  .legend{display:flex; gap:12px; align-items:center}
  .lg{display:flex; gap:6px; align-items:center; color:var(--sub); font-size:12px}
  .dot{width:12px; height:4px; border-radius:2px}
  .d1{background:var(--line1)} .d2{background:var(--line2)} .d3{background:var(--band)}
  .bar-legend{display:flex; gap:8px; font-size:12px; color:var(--sub)}
  .sticky-top{position:sticky; top:0; background:var(--panel); z-index:2; padding-bottom:6px; border-bottom:1px solid #0e141b}

  /* ====== Responsive charts (SVG heights) ====== */
  .chart-h { height: clamp(240px, 42vh, 440px); }
  .bars-h  { height: clamp(180px, 32vh, 260px); }
  .tbl-h   { max-height: clamp(220px, 40vh, 300px); overflow:auto; }

  /* ====== Breakpoints ====== */
  /* Large tablets: чуть уже сайдбар */
  @media (max-width: 1200px){
    .wrap{grid-template-columns:280px 1fr}
    .kpi{grid-template-columns:repeat(3,1fr)}
  }
  /* Tablets & small laptops: KPI по 2 в ряд, 2-колоночные блоки в одну колонку */
  @media (max-width: 992px){
    .wrap{grid-template-columns:1fr}
    aside{max-height:none; position:relative}
    .sticky-top{position:static; border-bottom:none; padding-bottom:0}
    .two{grid-template-columns: 1fr}
    .kpi{grid-template-columns:repeat(2,1fr)}
  }
  /* Phones: один столбец, крупнее цели для тапа, растягиваем инпуты/селекты */
  @media (max-width: 640px){
    body{font-size:15px}
    .wrap{padding:10px; gap:10px}
    .grid{padding:10px}
    .row{flex-wrap:wrap; align-items:flex-start}
    .row > span:first-child{flex:1 1 100%}
    .row input[type="number"], .row input[type="text"]{width:100%}
    .row input[type="range"]{width:100%}
    select{width:100%}
    .k big{font-size:17px}
    .foot{flex-direction:column; align-items:flex-start; gap:10px}
  }
  /* Very small phones */
  @media (max-width: 380px){
    .kpi{grid-template-columns:1fr}
  }
</style>
</head>
<body>
<div class="wrap">
  <aside>
    <div class="sticky-top">
      <h1>От классики к ML (Classic → ML)</h1>
      <div class="hint">Интерактив: переключайте модели и фичи — смотрите, как синеe п50 «липнет» к жёлтой фактической линии и как падает MAPE.</div>
    </div>

    <div class="section">
      <b>1) Цель & Горизонт (Target & Horizon)</b>
      <div class="row">
        <span>Горизонт, недель (Horizon, weeks)</span>
        <input id="hWeeks" type="range" min="2" max="12" value="4"/>
        <span id="hWeeksVal" class="chip">4</span>
      </div>
      <div class="row">
        <span>История, недель (History, weeks)</span>
        <input id="histWeeks" type="range" min="8" max="52" value="26"/>
        <span id="histWeeksVal" class="chip">26</span>
      </div>
      <div class="row">
        <span>SKU</span>
        <select id="skuSelect">
          <option value="0">SKU A — напиток</option>
          <option value="1">SKU B — шоколад</option>
          <option value="2">SKU C — кофе</option>
        </select>
      </div>
    </div>

    <div class="section">
      <b>2) Подготовка данных (Data Prep)</b>
      <div class="row"><label><input type="checkbox" id="prep_oos"> OOS (потери 40%) / OOS noise</label></div>
      <div class="row"><label><input type="checkbox" id="prep_depromo"> de-promo (срез пиков, если Promo выкл.)</label></div>
      <div class="row"><label><input type="checkbox" id="prep_impute" checked> импутация пропусков (Imputation)</label></div>
    </div>

    <div class="section">
      <b>3) Фичи (Features)</b>
      <div class="row"><label><input type="checkbox" id="f_dow" checked> День недели (Day of Week)</label></div>
      <div class="hint">Повторяемость по дням недели (пн-вс) / weekly pattern.</div>
      <div class="row"><label><input type="checkbox" id="f_season" checked> Сезон (Season: sin/cos + тренд)</label></div>
      <div class="hint">Годовая волна и плавный тренд / yearly wave & trend.</div>
      <div class="row"><label><input type="checkbox" id="f_weather" checked> Погода (Weather: cold_index)</label></div>
      <div class="hint">Холод ↑ → спрос ↑ для горячих напитков.</div>
      <div class="row"><label><input type="checkbox" id="f_price" checked> Цена (Price: up/down)</label></div>
      <div class="hint">Скидка стимулирует спрос, рост цены — сдерживает.</div>
      <div class="row"><label><input type="checkbox" id="f_promo" checked> Промо (Promotion)</label></div>
      <div class="hint">Короткие всплески 2–3 дня / short promo spikes.</div>
      <div class="row"><label><input type="checkbox" id="f_holiday" checked> Праздники (Holidays)</label></div>
      <div class="hint">14 Feb, 31 Oct.</div>
      <div class="row"><label><input type="checkbox" id="f_buzz" checked> Соцсети (Social Buzz)</label></div>
      <div class="hint">Инфоповоды/тренды влияют на спрос.</div>
    </div>

    <div class="section">
      <b>4) Модели (Models)</b>
      <div class="row"><label><input name="model" type="radio" value="naive"> Naive — вчера = сегодня</label></div>
      <div class="row"><label><input name="model" type="radio" value="ma" checked> Moving Average (MA)</label><span>k=<input id="ma_k" type="number" value="7" min="2" max="30"></span></div>
      <div class="row"><label><input name="model" type="radio" value="snaive"> Seasonal Naive</label><span>m=<input id="s_m" type="number" value="7" min="2" max="30"></span></div>
      <div class="row"><label><input name="model" type="radio" value="ses"> SES (Exp. Smoothing)</label><span>α=<input id="ses_a" type="number" step="0.05" value="0.3" min="0.05" max="0.95"></span></div>
      <div class="row"><label><input name="model" type="radio" value="holt"> Holt (trend)</label><span>α=<input id="holt_a" type="number" step="0.05" value="0.4"> β=<input id="holt_b" type="number" step="0.05" value="0.2"></span></div>
      <div class="row"><label><input name="model" type="radio" value="hw"> Holt–Winters</label><span>α=<input id="hw_a" type="number" step="0.05" value="0.3"> β=<input id="hw_b" type="number" step="0.05" value="0.1"> γ=<input id="hw_g" type="number" step="0.05" value="0.3"></span></div>
      <div class="row"><label><input name="model" type="radio" value="arima"> ARIMA(0,1,1)</label></div>
      <div class="row"><label><input name="model" type="radio" value="sarima"> SARIMA (0,1,1)x(0,1,1)m</label><span>m=<input id="sar_m" type="number" value="7" min="2" max="30"></span></div>
      <div class="row"><label><input name="model" type="radio" value="lin"> ML: Linear (OLS)</label></div>
      <div class="row"><label><input name="model" type="radio" value="tree"> ML: Tree-like (pseudo)</label></div>
      <div class="row"><label><input name="model" type="radio" value="ens"> Ensemble (50/50 ML & HW)</label></div>
      <div class="model-note">Подписи кратко поясняют различия (short differences explained).</div>
    </div>

    <div class="section">
      <b>5) Риски (Risks)</b>
      <div class="row"><label><input type="checkbox" id="risk_leak"> Data Leakage (предупреждение)</label></div>
      <div class="row"><label><input type="checkbox" id="risk_drift"> Drift (дрейф будущего)</label></div>
      <div class="row"><button id="btnRetrain">Retrain (переобучить)</button></div>
      <div id="warnLeak" class="warnline" style="display:none">Внимание: избегаем утечки — признаки будущего не попадают в train (No future leakage).</div>
    </div>
  </aside>

  <main>
    <div class="grid" style="padding:0">
      <div class="foot" style="padding:8px 10px 0 10px">
        <div class="legend">
          <div class="lg"><span class="dot d2"></span> Actual (Факт)</div>
          <div class="lg"><span class="dot d1"></span> Forecast p50</div>
          <div class="lg"><span class="dot d3"></span> p10–p90</div>
        </div>
        <div class="toolbar">
          <button id="btnReset">Reset</button>
          <button id="btnCSV">Скачать CSV</button>
        </div>
      </div>
      <svg id="chart" viewBox="0 0 1200 420" preserveAspectRatio="none"
           style="width:100%; display:block; background:linear-gradient(180deg,#0f1520,#0e141b)"
           class="chart-h"></svg>
    </div>

    <div class="kpi">
      <div class="k"><b>MAPE (train)</b><big id="k_mape_tr">–</big></div>
      <div class="k"><b>MAPE (val)</b><big id="k_mape_val">–</big></div>
      <div class="k"><b>Bias (val)</b><big id="k_bias">–</big></div>
      <div class="k"><b>FVA vs Naive</b><big id="k_fva">–</big></div>
      <div class="k"><b>Champion</b><big id="k_champ">–</big><div class="tag" id="k_champ_val"></div></div>
      <div class="k"><b>Challenger</b><big id="k_chal">–</big><div class="tag" id="k_chal_val"></div></div>
    </div>

    <div class="two">
      <div class="grid">
        <div class="bar-legend">Ошибка (Error), ниже — лучше (lower is better)</div>
        <svg id="bars" viewBox="0 0 600 220" style="width:100%; display:block" class="bars-h"></svg>
      </div>
      <div class="grid">
        <div id="explainTitle" style="margin-bottom:6px"><b>Объяснимость (Explainability)</b></div>
        <div id="explainBox" style="max-height:200px; overflow:auto"></div>
      </div>
    </div>

    <div class="grid">
      <b>Multi-horizon (weeks 1–12) — p50 / p10 / p90</b>
      <div class="tbl-h">
        <table id="mhTable"></table>
      </div>
    </div>
  </main>
</div>

<script>
/* ===== Utilities (без изменений твоей логики) ===== */
const rng = (()=>{ let s1=1234567, s2=8901234, s3=7777777; return ()=>{s1^=s1<<13; s1^=s1>>>17; s1^=s1<<5; const t=(s1+s2+s3)>>>0; s2=s1; s3=t; return (t>>>0)/4294967296} })();
function randn(){ let u=0,v=0; while(u===0)u=rng(); while(v===0)v=rng(); return Math.sqrt(-2*Math.log(u))*Math.cos(2*Math.PI*v) }
function clamp(x,a,b){return Math.max(a,Math.min(b,x))}
function mean(a){return a.reduce((s,x)=>s+x,0)/a.length}
function std(a){const m=mean(a); return Math.sqrt(mean(a.map(x=>(x-m)**2)))}
function sum(a){return a.reduce((s,x)=>s+x,0)}
function rollingMean(a,k){const out=[], q=[]; let s=0; for(let i=0;i<a.length;i++){q.push(a[i]); s+=a[i]; if(q.length>k){s-=q.shift()} out.push(q.length<k? s/q.length : s/k)} return out}
function range(n){return [...Array(n).keys()]}
function copy(a){return a.slice(0)}
function linspace(n, start=0){return range(n).map(i=>start+i)}
function add(a,b){return a.map((x,i)=>x+b[i])}
function mul(a,b){return a.map((x,i)=>x*b[i])}
function scale(a,c){return a.map(x=>x*c)}
function sigmoid(x){return 1/(1+Math.exp(-x))}

/* ===== Data generation, features, models, metrics, drawing — тут твой код как есть ===== */
/* ... (оставлено без изменений — скопировано из твоей версии) ... */

/* В качестве сокращения ответа: вставь сюда весь твой JS «как есть»,
   начиная от // ========================= Data Generation ========================= //
   и до конца, НО добавь два маленьких блока ниже (resize + iframe autoheight). */

/* ====== ДОБАВКА 1: Throttled resize для SVG ====== */
(function(){
  let t; window.addEventListener('resize', ()=>{
    clearTimeout(t);
    t = setTimeout(()=>{
      // у SVG нет Plotly, просто заставим браузер пересчитать layout
      const chart = document.getElementById('chart');
      const bars  = document.getElementById('bars');
      if(chart){ chart.style.height = getComputedStyle(chart).height; }
      if(bars){  bars.style.height  = getComputedStyle(bars).height;  }
      // и пересоберём таблицу высоту (CSS уже сделает своё)
      if (typeof parent !== 'undefined' && parent !== window) {
        parent.postMessage({type:"setHeight", height:document.documentElement.scrollHeight}, "*");
      }
    }, 120);
  });
})();

/* ====== ДОБАВКА 2: Auto-height при встраивании в iframe (Тильда) ====== */
function postAutoHeight(){
  if (typeof parent !== 'undefined' && parent !== window) {
    parent.postMessage({type:"setHeight", height:document.documentElement.scrollHeight}, "*");
  }
}
window.addEventListener('load', postAutoHeight);
document.addEventListener('DOMContentLoaded', postAutoHeight);
setTimeout(postAutoHeight, 400);

/* ====== Инициализация: вставь сюда вызов твоей buildAndRender(false) ====== */
// buildAndRender(false);
</script>
</body>
</html>
